
// HCL Modes
// a = No Boats
// B = Elimination
// c = All Random
// D = No Horn
// e = 6v6
// f = EQUAL random
// g = fast start
// h = -hm
// i = no trade
// j = op mode
// p = team kill off
// , = spawn boundaries
// = = HCL Lock, modes cant be entered.
// CLAN HCL CODE
// 0 = tdit
// 7 =  ittp
// 8 = tsot

library MapSetup initializer onInit requires TimerUtils, PublicLibrary, ClassTracking, GameMode

globals
    integer MODES_TIME_LIMIT = 15
    boolean mode_enter = true
    timer INSTANCE_TIMER = CreateTimer()
    timer MODES_TIMER = CreateTimer()
    timer GAME_TIMER = CreateTimer()
    timerdialog MODES_TIMER_DIALOG
    timerdialog NOOB_TIME_DIALOG
    integer array pnamePresent
    boolean array isobserver
    boolean obs_present = false
endglobals

function GetHost takes nothing returns nothing
    local gamecache g = InitGameCache("ITT.w3v")
    call StoreInteger(g, "Map", "Host", GetPlayerId(GetLocalPlayer ()))
    call TriggerSyncStart()
    call SyncStoredInteger(g, "Map", "Host" )
    call TriggerSyncReady()
    set udg_Host = Player( GetStoredInteger(g, "Map", "Host" ))
    call FlushGameCache(g )
    set g = null
endfunction

function ItemRecipeVision takes nothing returns nothing
    call CreateFogModifierRectBJ( true, GetEnumPlayer(), FOG_OF_WAR_VISIBLE, gg_rct_vision )
endfunction

function ResetBMSkills takes nothing returns nothing
    call resetBMSkill(GetEnumPlayer())
endfunction

function StartupGold takes nothing returns nothing
    call SetPlayerState(GetEnumPlayer(), PLAYER_STATE_RESOURCE_LUMBER, 1 )
endfunction

function Start_Game takes nothing returns nothing
    call ReleaseTimer(GetExpiredTimer())

    call Map.fireStartGameEvents()

    call DisplayTText(GENERAL_COLOR+"Game has begun.|r", 10)

    set NOOB_TIME_DIALOG = CreateTimerDialog(udg_noobTimer)
    call TimerDialogSetTitle(NOOB_TIME_DIALOG, "Grace Period")
    call TimerDialogDisplay(NOOB_TIME_DIALOG, true)
    call TimerStart(udg_noobTimer, udg_NOOB_TIME_LEFT , false , null)

    call RegisterPlayersTrollClasses()
    
    call TriggerRegisterTimerEvent( gg_trg_stats_degrading, udg_STAT_LOWER_INTERVAL, true)
    call TriggerRegisterTimerEvent( gg_trg_warmth, udg_CLOTHS_HEATUP_INTERVAL, true )
endfunction

function RemoveUnitX takes nothing returns nothing
    call RemoveUnit(GetEnumUnit())
endfunction

function IsMerchant takes nothing returns boolean
    return GetUnitTypeId(GetFilterUnit()) == UNIT_TROLL_MERCHANT
endfunction

function SlowDisplayea takes nothing returns nothing
    call ReleaseTimer(GetExpiredTimer())
    call TriggerExecute(gg_trg_ShowPlayers)
endfunction

function LocustDisplayUnits takes nothing returns nothing
    call UnitAddAbility( gg_unit_h000_0181 , 'Aloc')
    call UnitAddAbility( gg_unit_o00I_0173 , 'Aloc')
    call UnitAddAbility( gg_unit_o005_0176 , 'Aloc')
    call UnitAddAbility( gg_unit_o00K_0174 , 'Aloc')
    call UnitAddAbility( gg_unit_o003_0157 , 'Aloc')
    call UnitAddAbility( gg_unit_o004_0179 , 'Aloc')
    call UnitAddAbility( gg_unit_O00B_0180 , 'Aloc')
endfunction

function GenerateMap takes nothing returns nothing
    local timer t = NewTimer()
    local timer t2
    local integer INTEGER = 0
    local group g
    
    set udg_STARTED = true
    if BOARD_TEAM[1] == null then
        set t2 = NewTimer()
        call TimerStart(t2 , 10, false, function SlowDisplayea)
        set t2 = null
    else
        call TriggerExecute(gg_trg_ShowPlayers)
    endif
    call DisplayTText(GENERAL_COLOR+"Generating map...|r", 5)
    
    loop
        exitwhen INTEGER > 11
        set udg_orders[INTEGER] = "stay"
        set INTEGER = INTEGER + 1
    endloop

    call TimerStart(t , 3, false, function Start_Game)
    set t = null
endfunction

function FirstSpawnItemsAnimals takes nothing returns nothing
    call TriggerExecute(gg_trg_spawn_call_first)
endfunction

function RecallFirst takes nothing returns nothing
    call TimerStart(INSTANCE_TIMER, 0, false, function FirstSpawnItemsAnimals)
endfunction

function ModesTimerFinished takes nothing returns nothing
    set mode_enter = false
    call GameMode.deregisterAll()
    call TimerDialogDisplay(MODES_TIMER_DIALOG,false)
    call DestroyTimerDialog(MODES_TIMER_DIALOG)
    call MultiboardDisplay(MODE_BOARD,false)
    call ExecuteFunc("StartClassSelection")
endfunction

function Startup_Timer takes nothing returns nothing
    local integer i = 0
    local timer t

    call ReleaseTimer(GetExpiredTimer())
    call LockMammoth()
    call prepareSpells()

    // debug modes
    static if DEBUG_MODE then
        set HOSTING_CLAN = "DevSquad"
        //call GameModes_Action("-test mode",Player(0))
    endif

    //HCL Modes
    
    if checkHCLletter("a") then //no boats
        call GameModes_Action("-no boats",Player(0))
    endif
    if checkHCLletter("b") then //elimination
        call GameModes_Action("-elimination",Player(0))
    endif
    
    if checkHCLletter("c") then //all random
        call GameModes_Action("-all random",Player(0))
    endif
    
    if checkHCLletter("d") then //no horn
        call GameModes_Action("-no horn",Player(0))
    endif
    
    if checkHCLletter("e") then //6v6
        call GameModes_Action("-6v6",Player(0))
    endif
    
    if checkHCLletter("f") then //fixed random
        call GameModes_Action("-equal random",Player(0))
    endif
    
    if checkHCLletter("h") then //-hm
        call GameModes_Action("-hm",Player(0))
    endif
    
    if checkHCLletter("i") then //no trade
        call GameModes_Action("-no trade",Player(0))
    endif
    
    if checkHCLletter("j") then //op
        call GameModes_Action("-op",Player(0))
    endif
    
    if checkHCLletter("p") then //team kill disabled
        call GameModes_Action("-tko",Player(0))
    endif
    
    if checkHCLletter("=") then //locks hcl
        set mode_enter = false
        set MODES_TIME_LIMIT = 0
        call DisplayTText(GENERAL_COLOR+"Mode input is locked.", 45)
    else
        call DisplayTText(COLOR_CODE[GetPlayerId(modePlayer)]+GetPlayerName(modePlayer)+"|r"+GENERAL_COLOR+" can choose game modes.|r", 40)
    endif
    
    /*
    - Clan TdiT = 0
    - Clan Sort = 1
    - Clan MoSD = 2
    - Clan EITT = 3
    - Clan TmsT = 4
    - Clan TwS = 5
    - Clan BiTT = 6
    - Clan ITTP = 7
    - Clan TSOT = 8
    - Clan TwGB = .
    */

    if checkHCLletter(".") then
        set HOSTING_CLAN = "TwGB"
    elseif checkHCLletter("0") then
        set HOSTING_CLAN = "TdiT"
    elseif checkHCLletter("1") then
        set HOSTING_CLAN = "Sort"
    elseif checkHCLletter("2") then
        set HOSTING_CLAN = "TwA"
    elseif checkHCLletter("3") then
        set HOSTING_CLAN = "EITT"
    elseif checkHCLletter("4") then
        set HOSTING_CLAN = "TmsT"
    elseif checkHCLletter("5") then
        set HOSTING_CLAN = "TwS"
    elseif checkHCLletter("6") then
        set HOSTING_CLAN = "BiTT"
    elseif checkHCLletter("7") then
        set HOSTING_CLAN = "ITTP"
    elseif checkHCLletter("8") then
        set HOSTING_CLAN = "TSOT"
    endif

<% if @opt[:env] != 'pro' %>
    call DisplayTText( RED_COLOR + "Please remember, this is a BETA map!", 50 )
<% else %>
    call DisplayNewLine()
<% end %>

    if not( HOSTING_CLAN == "" ) then
        call DisplayTText( GENERAL_COLOR + "This game is hosted by " + GREEN_COLOR + "Clan " + HOSTING_CLAN + "|r", 50 )
        call Hints.add( "Use |r" + ENERGY_COLOR + "-bug the mammoth is flying!|r" + GENERAL_COLOR + " to report a bug with |r" + GOLD_COLOR +  "Clan " + HOSTING_CLAN + "|r" )
        call Hints.add( "Use |r" + ENERGY_COLOR + "-register rendo@example.com|r" + GENERAL_COLOR + " to register your email with |r" + GOLD_COLOR + "Clan " + HOSTING_CLAN + "|r" + GENERAL_COLOR + " to recieve info about arranged games and other news|r" )
    endif

    if HOSTING_CLAN == "TwGB" or HOSTING_CLAN == "DevSquad" then
        call DisplayTText( GOLD_COLOR + "Website:|r http://www.clantwgb.com", 50 )
        loop
            exitwhen i == 7
            call DisplayNewLine()
            set i = i + 1
        endloop
    else
        static if PRIVATE_MAP then
            call ClearTextMessages()
            call ShowInterface(false, 0)
            call EnableUserControl(false)
            call DisplayTText(RED_COLOR+"BETA TESTING ON TwGB BOTS ONLY",5000)
        endif
    endif

    call TimerStart(MODES_TIMER, MODES_TIME_LIMIT, false, function ModesTimerFinished)
    set MODES_TIMER_DIALOG = CreateTimerDialog(MODES_TIMER)
    call TimerDialogSetTitle(MODES_TIMER_DIALOG,"Select Modes")
    call TimerDialogDisplay(MODES_TIMER_DIALOG,true)

    call TimerStart(INSTANCE_TIMER, 36, false, function FirstSpawnItemsAnimals)
    call MultiboardDisplay(MODE_BOARD,true)
    call MultiboardMinimize(MODE_BOARD,true)
endfunction

private function onInit takes nothing returns nothing
    local integer i = 0
    local timer t = NewTimer()
    
    call SetTimeOfDayScale(130 * 0.01)
    call SetFloatGameState(GAME_STATE_TIME_OF_DAY, 3)
    call SetMapFlag( MAP_USE_HANDICAPS, false )
    call EnableMinimapFilterButtons( true, false )
    call SetCreepCampFilterState( false )
    
    static if LIBRARY_HydrAROUTINE then
        call AddItemToStockBJ( ITEM_HYDRA_HINT, gg_unit_n019_0145, 1, 1 )
    endif
    
    call ForForce(bj_FORCE_ALL_PLAYERS, function ItemRecipeVision )
    call ForForce(bj_FORCE_ALL_PLAYERS, function ResetBMSkills )
    call ForForce(bj_FORCE_ALL_PLAYERS, function StartupGold )
    
    call InitGameCacheBJ( "ITT.w3v" )
    set udg_jumpCache = bj_lastCreatedGameCache
    set udg_GameHash = InitHashtable()
    
    call GetHost()
    call UpdateBoardsLoopInit()
    call LocustDisplayUnits()
    call TimerStart(t,0,false,function Startup_Timer)
    call TimerStart(GAME_TIMER, 99999999, false, null)
    
    loop
        exitwhen i > 11
        if IsPlayerObserver(Player(i)) then
            set isobserver[i] = true
            set obs_present = true
            debug call DisplayText("obs detc")
        else
            set isobserver[i] = false
        endif
        set i = i + 1
    endloop
    
    set i = 0
    loop
        exitwhen i > 11
        if GetPlayerController(Player(i)) == MAP_CONTROL_USER and GetPlayerSlotState(Player(i)) == PLAYER_SLOT_STATE_PLAYING then
                set modePlayer = Player(i)
                set i = 12
        endif
        set i = i + 1
    endloop
    
    call GameMode.registerAll(modePlayer)
    call TriggerRegisterPlayerChatEvent( gg_trg_GameModes, modePlayer, "-", false )
    call TriggerRegisterPlayerChatEvent( gg_trg_no_trees, modePlayer, "-no trees", true )
    call TriggerRegisterPlayerChatEvent( gg_trg_no_herbs, modePlayer, "-no herbs", true )
    debug call DisplayTText("DEBUG MODE ACTIVE.", 999)
    call DisplayTText(COLOR_CODE[GetPlayerId(udg_Host)]+GetPlayerName(udg_Host)+"|r"+GENERAL_COLOR+" has been detected as the host.|r", 40)
    call DisplayTimedTextToPlayer(modePlayer,0,0,10,GENERAL_COLOR+"You have 15 seconds to enter modes|r")

    set t = null
endfunction

endlibrary